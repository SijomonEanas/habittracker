<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Monthly Habit Tracker</title>
<style>
        :root {
            --color-background: #0a0a0a;
            --color-surface: #1a1a1a;
            --color-text: #e0e0e0;
            --color-text-secondary: #888;
            --color-primary: #00ffff;
            --color-primary-hover: #00cccc;
            --color-border: rgba(0, 255, 255, 0.3);
            --color-success: #00ff00;
            --color-checked: rgba(0, 255, 255, 0.2);
            --radius-base: 8px;
            --radius-lg: 12px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;
        }

        [data-neon-theme="blue"] {
            --color-primary: #00ffff;
            --color-primary-hover: #00cccc;
            --color-border: rgba(0, 255, 255, 0.3);
            --color-success: #00ffff;
            --color-checked: rgba(0, 255, 255, 0.2);
        }

        [data-neon-theme="green"] {
            --color-primary: #00ff00;
            --color-primary-hover: #00cc00;
            --color-border: rgba(0, 255, 0, 0.3);
            --color-success: #00ff00;
            --color-checked: rgba(0, 255, 0, 0.2);
        }

        [data-neon-theme="pink"] {
            --color-primary: #ff00ff;
            --color-primary-hover: #cc00cc;
            --color-border: rgba(255, 0, 255, 0.3);
            --color-success: #ff00ff;
            --color-checked: rgba(255, 0, 255, 0.2);
        }

        [data-neon-theme="orange"] {
            --color-primary: #ff6600;
            --color-primary-hover: #cc5200;
            --color-border: rgba(255, 102, 0, 0.3);
            --color-success: #ff6600;
            --color-checked: rgba(255, 102, 0, 0.2);
        }

        [data-neon-theme="purple"] {
            --color-primary: #9933ff;
            --color-primary-hover: #7700cc;
            --color-border: rgba(153, 51, 255, 0.3);
            --color-success: #9933ff;
            --color-checked: rgba(153, 51, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);
            color: var(--color-text);
            padding: var(--space-24);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-24);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: var(--space-8);
            text-shadow: 0 0 10px var(--color-primary), 0 0 20px var(--color-primary), 0 0 30px var(--color-primary);
        }

        .theme-switcher {
            display: flex;
            gap: var(--space-8);
            justify-content: center;
            margin-bottom: var(--space-16);
        }

        .theme-btn {
            padding: 6px 12px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 0 15px var(--color-primary);
        }

        .theme-btn:hover {
            box-shadow: 0 0 25px var(--color-primary);
        }

        .add-habit-form {
            margin-bottom: var(--space-16);
            display: flex;
            gap: var(--space-8);
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .add-habit-form input,
        .add-habit-form select {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
        }

        .month-selector {
            display: flex;
            gap: var(--space-12);
            justify-content: center;
            align-items: center;
            margin-bottom: var(--space-24);
            flex-wrap: wrap;
        }

        .month-selector select {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            cursor: pointer;
        }

        .tracker-wrapper {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            border: 1px solid var(--color-border);
            overflow-x: auto;
            width: 100%;
            height: auto;
        }

        .tracker-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .tracker-table th,
        .tracker-table td {
            padding: var(--space-12);
            text-align: center;
            border: 2px solid var(--color-border);
            min-height: 45px;
        }

        .tracker-table th {
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 0 10px var(--color-primary);
        }

        .tracker-table th.habit-header {
            text-align: left;
            width: 250px;
            padding: var(--space-16);
            position: sticky;
            left: 0;
            z-index: 20;
        }

        .tracker-table th.day-header {
            width: 50px;
            font-size: 11px;
        }

        .tracker-table th.total-header {
            width: 80px;
            background-color: #ffd966;
            color: #0a0a0a;
        }

        .tracker-table td.habit-name {
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            padding: var(--space-16);
            width: 250px;
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: var(--color-surface);
        }

        .tracker-table td.day-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            min-height: 45px;
            padding: var(--space-12);
            width: 50px;
        }

        .tracker-table td.day-cell:hover {
            background-color: var(--color-checked);
        }

        .tracker-table td.day-cell.checked {
            background-color: var(--color-checked);
        }

        .tracker-table td.day-cell.checked::after {
            content: '‚úì';
            font-size: 18px;
            font-weight: bold;
            color: var(--color-success);
            text-shadow: 0 0 10px var(--color-success);
        }

        .tracker-table td.day-cell.count::after {
            content: attr(data-count);
            font-size: 12px;
            font-weight: bold;
            color: var(--color-primary);
        }

        .tracker-table td.total-cell {
            font-weight: 600;
            background-color: rgba(255, 217, 102, 0.2);
            font-size: 14px;
            width: 80px;
        }

        .habit-row {
            transition: background-color 0.2s;
        }

        .habit-row:nth-child(odd) { background: linear-gradient(90deg, rgba(0, 255, 255, 0.1) 0%, transparent 100%); }
        .habit-row:nth-child(even) { background: linear-gradient(90deg, rgba(0, 255, 0, 0.1) 0%, transparent 100%); }
        .habit-row:nth-child(3n) { background: linear-gradient(90deg, rgba(255, 0, 255, 0.1) 0%, transparent 100%); }
        .habit-row:nth-child(4n) { background: linear-gradient(90deg, rgba(255, 102, 0, 0.1) 0%, transparent 100%); }
        .habit-row:nth-child(5n) { background: linear-gradient(90deg, rgba(255, 255, 0, 0.1) 0%, transparent 100%); }

        .delete-btn {
            cursor: pointer;
            color: #ff4444;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background-color: rgba(255, 68, 68, 0.2);
        }

        .habit-type-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            background-color: var(--color-primary);
            color: white;
        }

        .move-btn {
            cursor: grab;
            color: var(--color-primary);
            font-weight: bold;
            padding: 2px 6px;
            margin-right: 8px;
            border-radius: 4px;
            transition: all 0.2s;
            user-select: none;
        }

        .move-btn:hover {
            background-color: var(--color-checked);
        }

        .move-btn:active {
            cursor: grabbing;
        }

        .habit-row.dragging {
            opacity: 0.5;
            border: 2px dashed var(--color-primary);
        }

        .habit-row.drag-over {
            border-top: 3px solid var(--color-primary);
        }

        .stats {
            margin-top: var(--space-24);
            display: flex;
            gap: var(--space-16);
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            min-width: 150px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
        }

        .stat-card p {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .buttons {
            margin-top: var(--space-16);
            display: flex;
            gap: var(--space-12);
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: var(--space-8) var(--space-16);
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 0 15px var(--color-primary);
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
            box-shadow: 0 0 25px var(--color-primary);
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: rgba(94, 82, 64, 0.05);
        }

        @media (max-width: 768px) {
            body {
                padding: var(--space-12);
            }
            
            .tracker-table {
                min-width: 800px;
            }
            
            .tracker-table th.habit-header,
            .tracker-table td.habit-name {
                width: 200px;
            }
            
            .tracker-table th.day-header,
            .tracker-table td.day-cell {
                width: 35px;
            }
            
            .add-habit-form {
                flex-direction: column;
            }
            
            .add-habit-form input,
            .add-habit-form select {
                width: 100%;
                max-width: 300px;
            }
        }
    
/* Dynamic today highlight color */
.today-highlight {
    background-color: var(--color-checked) !important;
    box-shadow: 0 0 15px var(--color-primary);
    border: 2px solid var(--color-primary);
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üìä Monthly Habit Tracker</h1>
<p style="color: var(--color-text-secondary);">Track your daily habits and build consistency</p>
</div>
<div class="theme-switcher">
<button class="theme-btn" onclick="rotateTheme()">üé® Change Theme</button>
</div>
<div class="add-habit-form">
<input id="newHabitInput" placeholder="New habit name" style="width: 200px;" type="text"/>
<select id="habitTypeSelect" onchange="toggleMaxInputs()">
<option value="tick">‚úì Tick</option>
<option value="time">üïê Time</option>
<option value="count">#Ô∏è‚É£ Count</option>
</select>
<input id="maxCountInput" max="100" min="1" placeholder="Max count" style="width: 100px; display: none;" type="number" value="10"/>
<div id="timeInputContainer" style="display: none; gap: 4px;">
<input id="maxTimeHours" max="24" min="0" placeholder="Hours" style="width: 70px;" type="number" value="1"/>
<span style="color: var(--color-text);">:</span>
<input id="maxTimeMinutes" max="59" min="0" placeholder="Mins" style="width: 70px;" type="number" value="0"/>
</div>
<button class="btn btn-primary" onclick="addHabit()">‚ûï Add Habit</button>
</div>
<div class="month-selector">
<label for="monthSelect">Month:</label>
<select id="monthSelect">
<option value="0">January</option>
<option value="1">February</option>
<option value="2">March</option>
<option value="3">April</option>
<option value="4">May</option>
<option value="5">June</option>
<option value="6">July</option>
<option value="7">August</option>
<option value="8">September</option>
<option value="9">October</option>
<option value="10">November</option>
<option value="11">December</option>
</select>
<label for="yearSelect">Year:</label>
<select id="yearSelect"></select>
</div>
<div class="tracker-wrapper">
<table class="tracker-table" id="trackerTable">
<thead>
<tr id="headerRow"></tr>
</thead>
<tbody id="trackerBody"></tbody>
</table>
</div>
<div class="stats">
<div class="stat-card">
<h3>Total Completions</h3>
<p id="totalCompletions">0</p>
</div>
<div class="stat-card">
<h3>Completion Rate</h3>
<p id="completionRate">0%</p>
</div>
<div class="stat-card">
<h3>Best Habit</h3>
<p id="bestHabit" style="font-size: 16px;">-</p>
</div>
</div>
<div class="buttons">
<button class="btn btn-primary" onclick="saveData()">üíæ Save Progress</button>
<button class="btn btn-primary" onclick="loadData()">üìÇ Load/Restore</button>
<button class="btn btn-secondary" onclick="clearData()">üóëÔ∏è Clear All</button>
</div>
<input accept=".json" id="fileInput" onchange="handleFileLoad(event)" style="display: none;" type="file"/>
</div>
<script>
        let habits = [
            {name: "Exercise/Workout", type: "tick"},
            {name: "Coding Practice", type: "tick"},
            {name: "Reading Books", type: "time", maxTime: 60},
            {name: "Meditation", type: "time", maxTime: 30},
            {name: "Wake Up Early", type: "tick"},
            {name: "Drink Water (8 glasses)", type: "count", maxCount: 8},
            {name: "Healthy Eating", type: "tick"},
            {name: "Study Cybersecurity", type: "time", maxTime: 120},
            {name: "English Practice", type: "time", maxTime: 45},
            {name: "Sleep 8 Hours", type: "tick"}
        ];

        let trackerData = {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        const neonThemes = ['blue', 'green', 'pink', 'orange', 'purple'];
        let currentThemeIndex = 0;

        function loadFromStorage() {
            const saved = localStorage.getItem('habitTrackerData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    trackerData = parsed.trackerData || {};
                    habits = parsed.habits || habits;
                    currentThemeIndex = parsed.themeIndex || 0;
                    applyNeonTheme(currentThemeIndex);
                } catch (error) {
                    console.error('Error loading from storage:', error);
                }
            }
        }

        function saveToStorage() {
            const dataToSave = {
                trackerData: trackerData,
                habits: habits,
                themeIndex: currentThemeIndex
            };
            localStorage.setItem('habitTrackerData', JSON.stringify(dataToSave));
        }

        function applyNeonTheme(index) {
            currentThemeIndex = index % neonThemes.length;
            const theme = neonThemes[currentThemeIndex];
            document.body.setAttribute('data-neon-theme', theme);
        }

        function rotateTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % neonThemes.length;
            applyNeonTheme(currentThemeIndex);
            saveToStorage();
        }

        function addHabit() {
            const input = document.getElementById('newHabitInput');
            const typeSelect = document.getElementById('habitTypeSelect');
            const maxCountInput = document.getElementById('maxCountInput');
            const maxTimeHours = document.getElementById('maxTimeHours');
            const maxTimeMinutes = document.getElementById('maxTimeMinutes');
            const habitName = input.value.trim();
            const habitType = typeSelect.value;
            
            if (habitName) {
                const newHabit = {name: habitName, type: habitType};
                if (habitType === 'count') {
                    newHabit.maxCount = parseInt(maxCountInput.value) || 10;
                } else if (habitType === 'time') {
                    const hours = parseInt(maxTimeHours.value) || 0;
                    const minutes = parseInt(maxTimeMinutes.value) || 0;
                    newHabit.maxTime = (hours * 60) + minutes;
                }
                habits.push(newHabit);
                input.value = '';
                maxCountInput.value = '10';
                maxTimeHours.value = '1';
                maxTimeMinutes.value = '0';
                saveToStorage();
                generateTracker();
            }
        }

        function deleteHabit(habitIndex) {
            if (confirm('Are you sure you want to delete this habit?')) {
                habits.splice(habitIndex, 1);
                const daysInMonth = getDaysInMonth(currentMonth, currentYear);
                for (let day = 1; day <= daysInMonth; day++) {
            const today = new Date();
            const isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
            
                    const key = `${currentYear}-${currentMonth}-${habitIndex}-${day}`;
                    delete trackerData[key];
                }
                saveToStorage();
                generateTracker();
            }
        }

        function initializeYearSelector() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function generateTracker() {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            currentMonth = parseInt(monthSelect.value);
            currentYear = parseInt(yearSelect.value);
            
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);
            const headerRow = document.getElementById('headerRow');
            const trackerBody = document.getElementById('trackerBody');
            
            headerRow.innerHTML = '<th class="habit-header">HABITS</th>';
            for (let day = 1; day <= daysInMonth; day++) {
            const today = new Date();
            const isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
            
                headerRow.innerHTML += `<th class="day-header ${isToday ? "today-highlight" : ""}">${day}</th>`;
            }
            headerRow.innerHTML += '<th class="total-header">Total</th>';
            
            trackerBody.innerHTML = '';
            habits.forEach((habit, habitIndex) => {
                const row = document.createElement('tr');
                row.className = 'habit-row';
                const typeBadge = habit.type === 'time' ? 'üïê' : habit.type === 'count' ? '#Ô∏è‚É£' : '‚úì';
                const maxCountText = habit.type === 'count' && habit.maxCount ? `/${habit.maxCount}` : '';
                let maxTimeText = '';
                if (habit.type === 'time' && habit.maxTime) {
                    const hours = Math.floor(habit.maxTime / 60);
                    const mins = habit.maxTime % 60;
                    if (habit.maxTime >= 60) {
                        maxTimeText = mins > 0 ? `/${hours}h ${mins}m` : `/${hours}h`;
                    } else {
                        maxTimeText = `/${mins}m`;
                    }
                }
                row.innerHTML = `<td class="habit-name">
                    <span class="move-btn" draggable="true" title="Drag to reorder">‚ò∞</span>
                    ${habit.name} <span class="habit-type-badge">${typeBadge}${maxCountText}${maxTimeText}</span>
                    <span class="delete-btn" onclick="deleteHabit(${habitIndex})" title="Delete habit">√ó</span>
                </td>`;
                row.setAttribute('draggable', 'true');
                row.setAttribute('data-habit-index', habitIndex);
                
                for (let day = 1; day <= daysInMonth; day++) {
            const today = new Date();
            const isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
            
                    const key = `${currentYear}-${currentMonth}-${habitIndex}-${day}`;
                    const cellData = trackerData[key];
                    let cellClass = '';
                    let dataAttr = '';
                    
                    if (cellData) {
                        if (habit.type === 'count' && typeof cellData === 'number') {
                            cellClass = 'checked count';
                            dataAttr = `data-count="${cellData}"`;
                        } else if (habit.type === 'time' && typeof cellData === 'number') {
                            cellClass = 'checked count';
                            const totalMinutes = cellData;
                            const hours = Math.floor(totalMinutes / 60);
                            const mins = totalMinutes % 60;
                            let displayTime = '';
                            if (totalMinutes >= 60) {
                                if (mins > 0) {
                                    displayTime = `${hours}h ${mins}m`;
                                } else {
                                    displayTime = `${hours}h`;
                                }
                            } else {
                                displayTime = `${mins}m`;
                            }
                            dataAttr = `data-count="${displayTime}"`;
                        } else if (cellData === true) {
                            cellClass = 'checked';
                        }
                    }
                    
                    row.innerHTML += `<td class="day-cell ${cellClass} ${isToday ? "today-highlight" : ""}" ${dataAttr} onclick="toggleDay(${habitIndex}, ${day}, event)"></td>`;
                }
                
                row.innerHTML += `<td class="total-cell" id="total-${habitIndex}">0</td>`;
                trackerBody.appendChild(row);
            });
            
            setupDragAndDrop();
            updateAllTotals();
            updateStats();
        }

        function toggleDay(habitIndex, day, event) {
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();
            
            if (currentYear === todayYear && currentMonth === todayMonth) {
                if (day !== todayDate && day !== todayDate - 1) {
                    if (!confirm(`‚ö†Ô∏è You're trying to edit day ${day}. Only today (${todayDate}) and yesterday (${todayDate - 1}) can be edited freely. Continue anyway?`)) {
                        return;
                    }
                }
            } else {
                if (!confirm(`‚ö†Ô∏è You're editing a past month. Continue?`)) {
                    return;
                }
            }
            
            const key = `${currentYear}-${currentMonth}-${habitIndex}-${day}`;
            const habit = habits[habitIndex];
            
            if (habit.type === 'time') {
                const currentMinutes = trackerData[key] || 0;
                const currentHours = Math.floor(currentMinutes / 60);
                const currentMins = currentMinutes % 60;
                
                const hours = prompt(`Enter hours (0-24):`, currentHours);
                if (hours === null) return;
                
                const minutes = prompt(`Enter minutes (0-59):`, currentMins);
                if (minutes === null) return;
                
                const hoursNum = parseInt(hours) || 0;
                const minutesNum = parseInt(minutes) || 0;
                
                if (hoursNum >= 0 && hoursNum <= 24 && minutesNum >= 0 && minutesNum <= 59) {
                    const totalMinutes = (hoursNum * 60) + minutesNum;
                    
                    if (totalMinutes > 0) {
                        trackerData[key] = totalMinutes;
                    } else {
                        delete trackerData[key];
                    }
                    
                    saveToStorage();
                    generateTracker();
                } else {
                    alert('Invalid time input! Hours: 0-24, Minutes: 0-59');
                }
                return;
            } else if (habit.type === 'count') {
                if (event && event.ctrlKey) {
                    if (trackerData[key] && typeof trackerData[key] === 'number' && trackerData[key] > 0) {
                        trackerData[key]--;
                        if (trackerData[key] <= 0) {
                            delete trackerData[key];
                        }
                    }
                } else {
                    if (!trackerData[key]) {
                        trackerData[key] = 1;
                    } else if (typeof trackerData[key] === 'number') {
                        trackerData[key]++;
                    } else {
                        trackerData[key] = 1;
                    }
                }
            } else {
                trackerData[key] = !trackerData[key];
            }
            
            saveToStorage();
            generateTracker();
        }

        let draggedHabitIndex = null;

        function setupDragAndDrop() {
            const rows = document.querySelectorAll('.habit-row');
            
            rows.forEach(row => {
                row.addEventListener('dragstart', (e) => {
                    draggedHabitIndex = parseInt(row.getAttribute('data-habit-index'));
                    row.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                row.addEventListener('dragend', (e) => {
                    row.classList.remove('dragging');
                    document.querySelectorAll('.habit-row').forEach(r => r.classList.remove('drag-over'));
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (draggedHabitIndex !== parseInt(row.getAttribute('data-habit-index'))) {
                        row.classList.add('drag-over');
                    }
                });

                row.addEventListener('dragleave', (e) => {
                    row.classList.remove('drag-over');
                });

                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    row.classList.remove('drag-over');
                    
                    const dropIndex = parseInt(row.getAttribute('data-habit-index'));
                    
                    if (draggedHabitIndex !== null && draggedHabitIndex !== dropIndex) {
                        const [draggedHabit] = habits.splice(draggedHabitIndex, 1);
                        habits.splice(dropIndex, 0, draggedHabit);
                        
                        saveToStorage();
                        generateTracker();
                    }
                });
            });
        }

        function updateAllTotals() {
            habits.forEach((habit, habitIndex) => {
                let count = 0;
                const daysInMonth = getDaysInMonth(currentMonth, currentYear);
                for (let day = 1; day <= daysInMonth; day++) {
            const today = new Date();
            const isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
            
                    const key = `${currentYear}-${currentMonth}-${habitIndex}-${day}`;
                    const value = trackerData[key];
                    if (value) {
                        if (habit.type === 'time' && typeof value === 'number') {
                            if (habit.maxTime) {
                                count += value / habit.maxTime;
                            } else {
                                count += value / 1440;
                            }
                        } else if (habit.type === 'count' && typeof value === 'number') {
                            if (habit.maxCount) {
                                const completion = value / habit.maxCount;
                                count += completion;
                            } else {
                                count += value;
                            }
                        } else if (value === true) {
                            count++;
                        }
                    }
                }
                const totalCell = document.getElementById(`total-${habitIndex}`);
                if (totalCell) {
                    if (habit.type === 'time' || habit.type === 'count') {
                        totalCell.textContent = count.toFixed(1);
                    } else {
                        totalCell.textContent = count;
                    }
                }
            });
        }

        function updateStats() {
            let totalCompletions = 0;
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);
            const totalPossible = habits.length * daysInMonth;
            const habitScores = {};

            habits.forEach((habit, habitIndex) => {
                let count = 0;
                for (let day = 1; day <= daysInMonth; day++) {
            const today = new Date();
            const isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
            
                    const key = `${currentYear}-${currentMonth}-${habitIndex}-${day}`;
                    const value = trackerData[key];
                    if (value) {
                        if (habit.type === 'time' && typeof value === 'number') {
                            if (habit.maxTime) {
                                const completion = value / habit.maxTime;
                                count += completion;
                                totalCompletions += completion;
                            } else {
                                count += value / 1440;
                                totalCompletions += value / 1440;
                            }
                        } else if (habit.type === 'count' && typeof value === 'number') {
                            if (habit.maxCount) {
                                const completion = value / habit.maxCount;
                                count += completion;
                                totalCompletions += completion;
                            } else {
                                count += value;
                                totalCompletions += value;
                            }
                        } else if (value === true) {
                            count++;
                            totalCompletions++;
                        }
                    }
                }
                habitScores[habit.name] = count;
            });

            document.getElementById('totalCompletions').textContent = Math.round(totalCompletions * 10) / 10;
            
            const rate = totalPossible > 0 ? Math.round((totalCompletions / totalPossible) * 100) : 0;
            document.getElementById('completionRate').textContent = rate + '%';

            const bestHabitEntry = Object.entries(habitScores).sort((a, b) => b[1] - a[1])[0];
            const bestHabitText = bestHabitEntry ? bestHabitEntry[0].split('/')[0] : '-';
            document.getElementById('bestHabit').textContent = bestHabitText;
        }

        function saveData() {
            const dataToSave = {
                trackerData: trackerData,
                habits: habits,
                themeIndex: currentThemeIndex
            };
            const dataStr = JSON.stringify(dataToSave, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `habit-tracker-${currentYear}-${currentMonth + 1}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Progress saved! Download the file to backup your data.');
        }

        function loadData() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    
                    if (loaded.trackerData) {
                        trackerData = loaded.trackerData;
                    }
                    if (loaded.habits) {
                        habits = loaded.habits;
                    }
                    if (loaded.themeIndex !== undefined) {
                        currentThemeIndex = loaded.themeIndex;
                        applyNeonTheme(currentThemeIndex);
                    }
                    
                    document.getElementById('monthSelect').value = currentMonth;
                    document.getElementById('yearSelect').value = currentYear;
                    
                    saveToStorage();
                    generateTracker();
                    updateStats();
                    alert('‚úÖ Data restored successfully!');
                } catch (error) {
                    console.error('Error loading file:', error);
                    alert('‚ùå Error loading file. Please make sure it\'s a valid habit tracker file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all habit data for this month?')) {
                const daysInMonth = getDaysInMonth(currentMonth, currentYear);
                habits.forEach((habit, habitIndex) => {
                    for (let day = 1; day <= daysInMonth; day++) {
            const today = new Date();
            const isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
            
                        const key = `${currentYear}-${currentMonth}-${habitIndex}-${day}`;
                        delete trackerData[key];
                    }
                });
                saveToStorage();
                generateTracker();
                alert('üóëÔ∏è All data cleared for this month!');
            }
        }

        function toggleMaxInputs() {
            const typeSelect = document.getElementById('habitTypeSelect');
            const maxCountInput = document.getElementById('maxCountInput');
            const timeInputContainer = document.getElementById('timeInputContainer');
            
            if (typeSelect.value === 'count') {
                maxCountInput.style.display = 'inline-block';
                timeInputContainer.style.display = 'none';
            } else if (typeSelect.value === 'time') {
                maxCountInput.style.display = 'none';
                timeInputContainer.style.display = 'flex';
            } else {
                maxCountInput.style.display = 'none';
                timeInputContainer.style.display = 'none';
            }
        }

        document.getElementById('monthSelect').addEventListener('change', generateTracker);
        document.getElementById('yearSelect').addEventListener('change', generateTracker);

        setInterval(saveToStorage, 30000);

        setInterval(function() {
            rotateTheme();
        }, 60000);

        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            initializeYearSelector();
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('yearSelect').value = currentYear;
            
            applyNeonTheme(currentThemeIndex);
            generateTracker();
        });
    
// Reapply highlight dynamically on theme change
const observer = new MutationObserver(() => {
    document.querySelectorAll('.today-highlight').forEach(cell => {
        cell.style.boxShadow = `0 0 15px var(--color-primary)`;
        cell.style.borderColor = `var(--color-primary)`;
    });
});
observer.observe(document.body, { attributes: true, attributeFilter: ['data-neon-theme'] });
</script>
</body>
</html>
